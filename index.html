<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade Data Viewer</title>
<style>
body{font-family:Arial,sans-serif;padding:20px;background:#f4f4f4;}
h1{margin-bottom:10px;}
#status{margin-bottom:10px;font-weight:bold;}
#preview{padding:15px;background:#fff;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:background 0.3s;}
table{border-collapse:collapse;width:100%;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;text-align:left;}
th{background-color:#f0f0f0;}
tr:nth-child(even){background-color:#f9f9f9;}
tr:hover{background-color:#f1f1f1;}
#search{margin-top:10px;padding:8px;width:50%;}
#timer{margin-top:10px;font-size:14px;color:#555;}
#refreshBtn{padding:10px 15px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;}
#refreshBtn:hover{opacity:0.9;}
</style>
</head>
<body>
<h1>üìä Trade Data Viewer</h1>
<div id="status">Menunggu refresh...</div>
<button id="refreshBtn">üîÑ Refresh Data</button>
<input type="text" id="search" placeholder="Ketik untuk mencari...">
<div id="preview"></div>
<div id="timer">‚è≥ Terakhir refresh: - detik</div>

<script>
const REPO_OWNER="kijangweb";
const REPO_NAME="probpair";
const FILE_PATH="tradeData.json";
const BRANCH="main";

const API_URL=`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`;
const RAW_URL=`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${FILE_PATH}`;

let lastData = null;
let lastSHA = null;
let secondsSinceRefresh = 0;

// Render preview table
function renderPreview(data){
  const container=document.getElementById("preview");
  if(!Array.isArray(data)||data.length===0){container.innerHTML="<p>Data kosong</p>";return;}
  const keys=Object.keys(data[0]);
  let html=`<table><thead><tr>`;
  keys.forEach(k=>html+=`<th>${k}</th>`); html+=`</tr></thead><tbody id="tableBody"></tbody></table>`;
  container.innerHTML=html;
  const renderRows=rows=>{
    const body=document.getElementById("tableBody"); body.innerHTML="";
    rows.forEach(row=>{let tr="<tr>"; keys.forEach(k=>tr+=`<td>${row[k]}</td>`); tr+="</tr>"; body.innerHTML+=tr;});
  }
  renderRows(data);

  // Search/filter
  document.getElementById("search").addEventListener("input", e=>{
    const q=e.target.value.toLowerCase();
    const filtered=data.filter(obj=>Object.values(obj).some(val=>String(val).toLowerCase().includes(q)));
    renderRows(filtered);
  });
}

// Fetch data from API + fallback raw URL
async function fetchData(){
  const status=document.getElementById("status");
  status.innerText="‚è≥ Memeriksa update‚Ä¶";
  try{
    const res=await fetch(API_URL+"&t="+Date.now());
    if(!res.ok) throw new Error("API gagal");
    const json=await res.json();
    const data=JSON.parse(atob(json.content));
    const sha=json.sha;

    if(sha === lastSHA){
      status.innerText="‚è≥ Menunggu update‚Ä¶ (progress di repo masih sama)";
    } else {
      lastSHA=sha;
      lastData=data;
      renderPreview(data);
      status.innerText="‚úÖ Data baru berhasil di-load!";
      const preview=document.getElementById("preview");
      preview.style.background="#d4edda";
      setTimeout(()=>{preview.style.background="#fff";},500);
      secondsSinceRefresh=0;
    }
  }catch(err){
    // fallback ke raw URL
    try{
      const resRaw=await fetch(RAW_URL+"?t="+Date.now());
      if(!resRaw.ok) throw new Error("Raw gagal");
      const data=await resRaw.json();
      if(JSON.stringify(data) === JSON.stringify(lastData)){
        status.innerText="‚è≥ Menunggu update‚Ä¶ (progress di CDN masih sama)";
      } else {
        lastData=data;
        renderPreview(data);
        status.innerText="‚úÖ Data baru berhasil di-load (CDN fallback)";
        const preview=document.getElementById("preview");
        preview.style.background="#d4edda";
        setTimeout(()=>{preview.style.background="#fff";},500);
        secondsSinceRefresh=0;
      }
    }catch(err2){
      status.innerText="‚ùå Gagal fetch data: "+err2.message;
    }
  }
}

// Countdown timer since last refresh
setInterval(()=>{
  secondsSinceRefresh++;
  document.getElementById("timer").innerText=`‚è≥ Terakhir refresh: ${secondsSinceRefresh} detik`;
},1000);

// Manual refresh button
document.getElementById("refreshBtn").addEventListener("click",fetchData);

// Load pertama kali
fetchData();
</script>
</body>
</html>
