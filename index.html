<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trade Data Viewer (API + Raw Fallback)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { margin-bottom: 10px; }
    #status { margin-bottom: 15px; font-weight: bold; }
    #preview { padding: 15px; background: #fff; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
    #refreshBtn { padding: 10px 15px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    #refreshBtn:hover { opacity: 0.9; }
    #search { margin-top: 10px; padding: 8px; width: 50%; }
    #lastUpdated { margin-top: 12px; font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <h1>üìä Trade Data Viewer</h1>
  <div id="status">Memuat data...</div>
  <button id="refreshBtn">üîÑ Refresh Manual</button>
  <input type="text" id="search" placeholder="Ketik untuk mencari...">
  <div id="preview"></div>
  <div id="lastUpdated">‚è± Belum ada data.</div>

  <script>
    const API_URL = "https://api.github.com/repos/kijangweb/probpair/contents/tradeData.json?ref=main";
    const RAW_URL = "https://raw.githubusercontent.com/kijangweb/probpair/main/tradeData.json";

    async function loadData(auto=false) {
      try {
        // 1. Coba lewat API
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("API Error: " + res.status);
        const json = await res.json();

        if (json.message && json.message.includes("API rate limit exceeded")) {
          throw new Error("RateLimit");
        }

        const decoded = JSON.parse(atob(json.content));
        renderPreview(decoded);
        updateTimestamp("API");

        document.getElementById("status").innerText =
          auto ? "üîÑ Auto-refresh (API): Data diperbarui!" : "‚úÖ Data dimuat dari API.";
      } catch (err) {
        console.warn("API gagal:", err.message);

        // 2. Fallback ke RAW
        try {
          const resRaw = await fetch(RAW_URL + "?t=" + Date.now());
          if (!resRaw.ok) throw new Error("Raw fetch gagal");
          const data = await resRaw.json();
          renderPreview(data);
          updateTimestamp("RAW");

          document.getElementById("status").innerText =
            auto ? "üîÑ Auto-refresh (RAW): Data diperbarui (fallback)." : "‚úÖ Data dimuat dari RAW (fallback).";
        } catch (err2) {
          document.getElementById("status").innerText = "‚ùå Error total: " + err2.message;
        }
      }
    }

    function renderPreview(data) {
      const container = document.getElementById("preview");
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p>Data kosong</p>";
        return;
      }

      const keys = Object.keys(data[0]);
      let html = `
        <table>
          <thead><tr>
      `;
      keys.forEach(k => {
        html += `<th>${k}</th>`;
      });
      html += `</tr></thead><tbody id="tableBody"></tbody></table>`;
      container.innerHTML = html;

      function renderRows(rows) {
        const body = document.getElementById("tableBody");
        body.innerHTML = "";
        rows.forEach(row => {
          let tr = "<tr>";
          keys.forEach(k => {
            tr += `<td>${row[k]}</td>`;
          });
          tr += "</tr>";
          body.innerHTML += tr;
        });
      }

      renderRows(data);

      document.getElementById("search").addEventListener("input", e => {
        const q = e.target.value.toLowerCase();
        const filtered = data.filter(obj =>
          Object.values(obj).some(val =>
            String(val).toLowerCase().includes(q)
          )
        );
        renderRows(filtered);
      });
    }

    function updateTimestamp(source) {
      const now = new Date();
      const formatted = now.toLocaleString();
      document.getElementById("lastUpdated").innerText =
        `‚è± Terakhir diperbarui: ${formatted} (sumber: ${source})`;
    }

    document.getElementById("refreshBtn").addEventListener("click", () => loadData(false));

    setInterval(() => loadData(true), 15000);

    loadData(false);
  </script>
</body>
</html>
