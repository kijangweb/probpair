<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade Data Viewer</title>
<style>
body { font-family: Arial; padding:20px; background:#f4f4f4 }
table { border-collapse: collapse; width:100%; margin-top:10px }
th, td { border:1px solid #ddd; padding:8px; text-align:left }
th { background:#f0f0f0 }
tr:nth-child(even){background:#f9f9f9}
tr:hover{background:#f1f1f1}
#status{margin-bottom:10px;font-weight:bold}
#refreshBtn{padding:10px 15px; background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer}
#refreshBtn:hover{opacity:0.9}
#search{margin-top:10px;padding:8px;width:50%}
</style>
</head>
<body>
<h1>üìä Trade Data Viewer</h1>
<div id="status">Memuat data...</div>
<button id="refreshBtn">üîÑ Refresh Data</button>
<input type="text" id="search" placeholder="Ketik untuk mencari...">
<div id="preview"></div>
<div id="lastUpdate"></div>

<script>
const PROXY_URL = "/api/tradeData";
const LAST_UPDATE_URL = "/api/lastUpdate";

async function fetchData() {
  document.getElementById("status").innerText = "‚è≥ Memuat data...";
  try {
    const res = await fetch(PROXY_URL + "?t=" + Date.now());
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();
    renderTable(data);
    document.getElementById("status").innerText = "‚úÖ Data berhasil dimuat";
  } catch(err) {
    document.getElementById("status").innerText = "‚ùå Error: " + err.message;
  }
  fetchLastUpdate();
}

function renderTable(data) {
  const container = document.getElementById("preview");
  if(!Array.isArray(data) || data.length===0){container.innerHTML="<p>Data kosong</p>";return;}
  const keys = Object.keys(data[0]);
  let html = "<table><thead><tr>";
  keys.forEach(k=>html+=`<th>${k}</th>`);
  html+="</tr></thead><tbody id='tableBody'></tbody></table>";
  container.innerHTML = html;
  renderRows(data);

  document.getElementById("search").addEventListener("input", e=>{
    const q = e.target.value.toLowerCase();
    const filtered = data.filter(obj=>Object.values(obj).some(val=>String(val).toLowerCase().includes(q)));
    renderRows(filtered);
  });
}

function renderRows(rows){
  const body = document.getElementById("tableBody");
  body.innerHTML="";
  rows.forEach(row=>{
    let tr="<tr>";
    Object.values(row).forEach(v=>tr+=`<td>${v}</td>`);
    tr+="</tr>";
    body.innerHTML+=tr;
  });
}

async function fetchLastUpdate(){
  try{
    const res = await fetch(LAST_UPDATE_URL);
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();
    document.getElementById("lastUpdate").innerText = "Terakhir update repo: " + data.lastUpdate;
  }catch(err){
    document.getElementById("lastUpdate").innerText = "";
  }
}

document.getElementById("refreshBtn").addEventListener("click", fetchData);
fetchData();
</script>
</body>
</html>
